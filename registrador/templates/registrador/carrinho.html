<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <title>Seu Carrinho</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>

    <div class="container mt-4">
        <h1 class="text-center mb-4">üõí Seu Carrinho - Pedido #{{ pedido.id }}</h1>

        {% if pedido %}
        <table class="table table-bordered table-striped">
            <thead class="table-dark">
                <tr>
                    <th>Produto</th>
                    <th>Quantidade</th>
                    <th>Pre√ßo Unit√°rio</th>
                    <th>Subtotal</th>
                    <th>Observa√ß√£o</th>
                    <th>Excluir item</th>
                </tr>
            </thead>
            <tbody>
                {% for item in pedido.itens.all %}
                <tr>
                    {% if item.descricao_produto %}
                    <td>{{ item.descricao_produto }}</td>
                    {% else %}
                    <td>{{ item.produto.nome }}</td>
                    {% endif %}

                    <td>{{ item.quantidade }}</td>

                    {% if item.produto.preco %}
                    <td>R$ {{ item.produto.preco|floatformat:2 }}</td>
                    {% else %}
                    <td>R$ {{ item.preco_unitario|floatformat:2 }}</td>
                    {% endif %}

                    <td>R$ {{ item.subtotal|floatformat:2 }}</td>

                    <!-- üîπ Formul√°rio de observa√ß√£o -->
                    <td>
                        <form action="{% url 'atualizar_observacao' item.id %}" method="post" class="d-flex">
                            {% csrf_token %}
                            <input type="text" name="observacao" value="{{ item.observacao }}"
                                   class="form-control form-control-sm me-2"
                                   placeholder="Ex: sem cebola">
                            <button type="submit" class="btn btn-sm btn-primary">üíæ</button>
                        </form>
                    </td>

                    <td>
                        <a href="{% url 'excluir_item' item.id %}" class="btn btn-danger center">Excluir</a>
                    </td>
                </tr>
                {% endfor %}

                <tr>
                    <td colspan="4" class="text-end"><strong>Total:</strong></td>
                    <td colspan="2">R$ {{ pedido.total|floatformat:2 }}</td>
                </tr>
            </tbody>
        </table>

        <!-- üîπ Formul√°rio principal com ID para valida√ß√£o -->
        <form id="form_finalizar" action="{% url 'finalizar_pedido' %}" method="post">
            {% csrf_token %}

            <div class="mb-3">
                <label>Nome do Cliente</label>
                <input type="text" name="nome_cliente" class="form-control" placeholder="Digite o nome" required>
            </div>

            <div class="mb-3">
                <label>Local de Consumo</label>
                <select name="local_consumo" class="form-control" required>
                    <option value="">Selecione</option>
                    <option value="Levar">Levar</option>
                    <option value="Fora">Fora</option>
                    <option value="Altos">Alto</option>
                    <option value="Delivery">Delivery</option>
                    <option value="Mesa 1">Mesa 1</option>
                    <option value="Mesa 2">Mesa 2</option>
                    <option value="Mesa 3">Mesa 3</option>
                    <option value="Mesa 4">Mesa 4</option>
                    <option value="Mesa 5">Mesa 5</option>
                    <option value="Mesa 6">Mesa 6</option>
                    <option value="Mesa 7">Mesa 7</option>
                    <option value="Mesa 8">Mesa 8</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label">Forma de Pagamento</label>
                <div class="alert alert-info">
                    <strong>Total do pedido: R$ {{ pedido.total|floatformat:2 }}</strong>
                </div>
                
                <div class="row mb-2">
                    <div class="col-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="forma_pagamento" value="Dinheiro" id="dinheiro" onchange="toggleValorInput('dinheiro')">
                            <label class="form-check-label" for="dinheiro">üíµ Dinheiro</label>
                        </div>
                    </div>
                    <div class="col-6">
                        <input type="number" name="valor_dinheiro" id="valor_dinheiro" class="form-control" placeholder="R$ 0,00" step="0.01" min="0" disabled onchange="calcularResto()">
                    </div>
                </div>
                
                <div class="row mb-2">
                    <div class="col-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="forma_pagamento" value="Credito" id="credito" onchange="toggleValorInput('credito')">
                            <label class="form-check-label" for="credito">üí≥ Cr√©dito</label>
                        </div>
                    </div>
                    <div class="col-6">
                        <input type="number" name="valor_credito" id="valor_credito" class="form-control" placeholder="R$ 0,00" step="0.01" min="0" disabled onchange="calcularResto()">
                    </div>
                </div>
                
                <div class="row mb-2">
                    <div class="col-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="forma_pagamento" value="Debito" id="debito" onchange="toggleValorInput('debito')">
                            <label class="form-check-label" for="debito">üí≥ D√©bito</label>
                        </div>
                    </div>
                    <div class="col-6">
                        <input type="number" name="valor_debito" id="valor_debito" class="form-control" placeholder="R$ 0,00" step="0.01" min="0" disabled onchange="calcularResto()">
                    </div>
                </div>
                
                <div class="row mb-2">
                    <div class="col-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="forma_pagamento" value="Pix" id="pix" onchange="toggleValorInput('pix')">
                            <label class="form-check-label" for="pix">üì± Pix</label>
                        </div>
                    </div>
                    <div class="col-6">
                        <input type="number" name="valor_pix" id="valor_pix" class="form-control" placeholder="R$ 0,00" step="0.01" min="0" disabled onchange="calcularResto()">
                    </div>
                </div>
                
                <div id="resumo_pagamento" class="mt-3 alert alert-secondary" style="display: none;">
                    <strong>Resumo do Pagamento:</strong>
                    <div id="valores_informados"></div>
                    <div id="total_informado" class="fw-bold"></div>
                    <div id="diferenca" class="fw-bold"></div>
                </div>
                
                <small class="text-muted">Informe o valor para cada forma de pagamento selecionada</small>
            </div>

            <button type="submit" class="btn btn-success">
                ‚úîÔ∏è Finalizar Pedido
            </button>
            <a href="{% url 'menu' %}" class="btn btn-secondary">
                ‚Ü©Ô∏è Voltar ao Menu
            </a>
        </form>

        {% else %}
        <div class="alert alert-warning text-center">
            Seu carrinho est√° vazio.
        </div>
        <div class="text-center">
            <a href="{% url 'menu' %}" class="btn btn-primary">
                ‚Ü©Ô∏è Voltar ao Menu
            </a>
        </div>
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const totalPedido = parseFloat("{{ pedido.total|default:0|floatformat:2 }}");
        
        function toggleValorInput(tipo) {
            const checkbox = document.getElementById(tipo);
            const valorInput = document.getElementById('valor_' + tipo);
            
            if (checkbox.checked) {
                valorInput.disabled = false;
                valorInput.focus();
            } else {
                valorInput.disabled = true;
                valorInput.value = '';
            }
            calcularResto();
        }
        
        function calcularResto() {
            const formas = ['dinheiro', 'credito', 'debito', 'pix'];
            let totalInformado = 0;
            let valoresDetalhados = [];
            let algumValorInformado = false;
            
            formas.forEach(forma => {
                const checkbox = document.getElementById(forma);
                const valorInput = document.getElementById('valor_' + forma);
                
                if (checkbox.checked && valorInput.value) {
                    const valor = parseFloat(valorInput.value);
                    totalInformado += valor;
                    valoresDetalhados.push(`${forma.charAt(0).toUpperCase() + forma.slice(1)}: R$ ${valor.toFixed(2)}`);
                    algumValorInformado = true;
                }
            });
            
            const resumo = document.getElementById('resumo_pagamento');
            const valoresDiv = document.getElementById('valores_informados');
            const totalDiv = document.getElementById('total_informado');
            const diferencaDiv = document.getElementById('diferenca');
            
            if (algumValorInformado) {
                resumo.style.display = 'block';
                valoresDiv.innerHTML = valoresDetalhados.join('<br>');
                totalDiv.innerHTML = `Total informado: R$ ${totalInformado.toFixed(2)}`;
                
                const diferenca = totalInformado - totalPedido;
                if (diferenca > 0) {
                    diferencaDiv.innerHTML = `<span class="text-success">Troco: R$ ${diferenca.toFixed(2)}</span>`;
                } else if (diferenca < 0) {
                    diferencaDiv.innerHTML = `<span class="text-danger">Faltam: R$ ${Math.abs(diferenca).toFixed(2)}</span>`;
                } else {
                    diferencaDiv.innerHTML = `<span class="text-success">‚úÖ Valor exato!</span>`;
                }
            } else {
                resumo.style.display = 'none';
            }
        }
        
        // üîπ Valida√ß√£o apenas no formul√°rio principal
        document.querySelector('#form_finalizar').addEventListener('submit', function(e) {
            const formasChecked = document.querySelectorAll('input[name="forma_pagamento"]:checked');
            
            if (formasChecked.length === 0) {
                e.preventDefault();
                alert('Selecione pelo menos uma forma de pagamento!');
                return;
            }
            
            let totalInformado = 0;
            let algumValorVazio = false;
            
            formasChecked.forEach(checkbox => {
                const tipo = checkbox.value.toLowerCase();
                const valorInput = document.getElementById('valor_' + tipo);
                
                if (!valorInput.value || parseFloat(valorInput.value) <= 0) {
                    algumValorVazio = true;
                } else {
                    totalInformado += parseFloat(valorInput.value);
                }
            });
            
            if (algumValorVazio) {
                e.preventDefault();
                alert('Informe valores v√°lidos para todas as formas de pagamento selecionadas!');
                return;
            }
            
            if (totalInformado < totalPedido) {
                e.preventDefault();
                alert(`O valor total informado (R$ ${totalInformado.toFixed(2)}) √© menor que o total do pedido (R$ ${totalPedido.toFixed(2)})!`);
                return;
            }
        });
    </script>
</body>

</html>
